<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rrrymz â€“ AI News Digest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .metric-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    const GITHUB_REPO = "antonshkurenko/rrrymz"; // Set to "owner/repo" to enable feedback buttons

    function MetricsBadge({ label, value, color }) {
      const colors = {
        red: "bg-red-100 text-red-800",
        blue: "bg-blue-100 text-blue-800",
        green: "bg-green-100 text-green-800",
        yellow: "bg-yellow-100 text-yellow-800",
      };
      return (
        <span className={`metric-badge ${colors[color] || colors.blue}`}>
          {label}: {value}/10
        </span>
      );
    }

    function FeedbackButton({ clusterId, type }) {
      if (!GITHUB_REPO) return null;
      const emoji = type === "like" ? "\u2191" : "\u2193";
      const title = type === "like" ? `[Like] ${clusterId}` : `[Dislike] ${clusterId}`;
      const url = `https://github.com/${GITHUB_REPO}/issues/new?template=${type}.yml&title=${encodeURIComponent(title)}&cluster_id=${encodeURIComponent(clusterId)}`;
      return (
        <a
          href={url}
          target="_blank"
          rel="noopener noreferrer"
          className="text-gray-400 hover:text-gray-600 text-sm px-1"
          title={type === "like" ? "Like this story" : "Dislike this story"}
        >
          {emoji}
        </a>
      );
    }

    function StoryCard({ story }) {
      const { headline, core_fact, summary, sources, metrics, cluster_id } = story;
      return (
        <article className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
          <div className="flex items-start justify-between gap-2">
            <h2 className="text-lg font-bold text-gray-900 leading-tight">{headline}</h2>
            <div className="flex gap-0.5 shrink-0">
              <FeedbackButton clusterId={cluster_id} type="like" />
              <FeedbackButton clusterId={cluster_id} type="dislike" />
            </div>
          </div>
          <p className="mt-2 text-sm font-semibold text-blue-700">{core_fact}</p>
          <p className="mt-2 text-sm text-gray-600 leading-relaxed">{summary}</p>
          <div className="mt-3 flex flex-wrap gap-2">
            <MetricsBadge label="Breaking" value={metrics.breaking} color={metrics.breaking >= 8 ? "red" : "blue"} />
            <MetricsBadge label="Importance" value={metrics.importance} color={metrics.importance >= 7 ? "yellow" : "blue"} />
            <MetricsBadge label="SNR" value={metrics.snr} color={metrics.snr >= 7 ? "green" : "blue"} />
          </div>
          {sources && sources.length > 0 && (
            <div className="mt-3 text-xs text-gray-400">
              {sources.map((url, i) => (
                <a key={i} href={url} target="_blank" rel="noopener noreferrer" className="hover:text-gray-600 underline mr-2">
                  Source {i + 1}
                </a>
              ))}
            </div>
          )}
        </article>
      );
    }

    function FilterBar({ filter, setFilter, storyCount }) {
      const filters = [
        { key: "all", label: "All" },
        { key: "breaking", label: "Breaking" },
        { key: "important", label: "Important" },
      ];
      return (
        <div className="flex items-center gap-3 mb-6">
          {filters.map(f => (
            <button
              key={f.key}
              onClick={() => setFilter(f.key)}
              className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                filter === f.key
                  ? "bg-gray-900 text-white"
                  : "bg-gray-200 text-gray-600 hover:bg-gray-300"
              }`}
            >
              {f.label}
            </button>
          ))}
          <span className="text-sm text-gray-400 ml-auto">{storyCount} stories</span>
        </div>
      );
    }

    function DateNav({ archive, currentDate, onSelect }) {
      if (!archive || archive.length === 0) return null;

      const currentIdx = archive.findIndex(e => e.date === currentDate);
      const hasPrev = currentIdx < archive.length - 1;
      const hasNext = currentIdx > 0;

      const btnClass = (enabled) =>
        `px-2 py-1 rounded text-sm ${
          enabled
            ? "text-gray-600 hover:bg-gray-200 cursor-pointer"
            : "text-gray-300 cursor-default"
        }`;

      return (
        <div className="flex items-center gap-2 mb-6">
          <button
            className={btnClass(hasPrev)}
            disabled={!hasPrev}
            onClick={() => hasPrev && onSelect(archive[currentIdx + 1].date)}
          >
            &larr; Older
          </button>
          <select
            className="text-sm border border-gray-200 rounded px-2 py-1 bg-white text-gray-700"
            value={currentDate || ""}
            onChange={(e) => onSelect(e.target.value)}
          >
            {archive.map(entry => (
              <option key={entry.date} value={entry.date}>
                {entry.date} ({entry.story_count} stories)
              </option>
            ))}
          </select>
          <button
            className={btnClass(hasNext)}
            disabled={!hasNext}
            onClick={() => hasNext && onSelect(archive[currentIdx - 1].date)}
          >
            Newer &rarr;
          </button>
          {currentIdx !== 0 && (
            <button
              className="text-sm text-blue-600 hover:text-blue-800 ml-2"
              onClick={() => onSelect(archive[0].date)}
            >
              Latest
            </button>
          )}
        </div>
      );
    }

    function DigestHeader({ date, metadata }) {
      return (
        <header className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">rrrymz</h1>
          <p className="text-sm text-gray-500 mt-1">AI-curated news digest</p>
          {metadata && metadata.total_discovered > 0 && (
            <p className="text-xs text-gray-400 mt-2">
              {metadata.total_discovered} discovered &rarr; {metadata.after_sentinel} filtered &rarr; {metadata.clusters_formed} clustered &rarr; {metadata.stories_published} published
            </p>
          )}
        </header>
      );
    }

    function App() {
      const [digest, setDigest] = useState(null);
      const [archive, setArchive] = useState([]);
      const [currentDate, setCurrentDate] = useState(null);
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(true);
      const [filter, setFilter] = useState("all");

      // Load archive index on mount
      useEffect(() => {
        fetch("archive.json")
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            if (data && data.digests && data.digests.length > 0) {
              setArchive(data.digests);
            }
          })
          .catch(() => {}); // archive.json is optional
      }, []);

      const loadDigest = useCallback((filename) => {
        setLoading(true);
        setError(null);
        fetch(filename)
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            setDigest(data);
            setCurrentDate(data.date || null);
            setLoading(false);
          })
          .catch(err => {
            setError(err.message);
            setLoading(false);
          });
      }, []);

      // Load latest on mount
      useEffect(() => {
        loadDigest("latest.json");
      }, [loadDigest]);

      const handleDateSelect = useCallback((date) => {
        const entry = archive.find(e => e.date === date);
        if (entry) {
          loadDigest(entry.file);
        }
      }, [archive, loadDigest]);

      const filteredStories = useMemo(() => {
        if (!digest) return [];
        const stories = digest.stories || [];
        if (filter === "breaking") return stories.filter(s => s.metrics.breaking >= 8);
        if (filter === "important") return stories.filter(s => s.metrics.importance >= 7);
        return stories;
      }, [digest, filter]);

      if (loading) {
        return (
          <div className="max-w-2xl mx-auto px-4 py-12">
            <p className="text-gray-500 text-center">Loading digest...</p>
          </div>
        );
      }

      if (error) {
        return (
          <div className="max-w-2xl mx-auto px-4 py-12">
            <p className="text-red-500 text-center">Failed to load digest: {error}</p>
            <p className="text-gray-400 text-center text-sm mt-2">Make sure latest.json is available.</p>
          </div>
        );
      }

      return (
        <div className="max-w-2xl mx-auto px-4 py-8">
          <DigestHeader date={currentDate} metadata={digest.metadata} />
          <DateNav archive={archive} currentDate={currentDate} onSelect={handleDateSelect} />
          <FilterBar filter={filter} setFilter={setFilter} storyCount={filteredStories.length} />
          {filteredStories.length === 0 ? (
            <p className="text-gray-400 text-center py-8">No stories match this filter.</p>
          ) : (
            <div className="space-y-4">
              {filteredStories.map(story => (
                <StoryCard key={story.cluster_id} story={story} />
              ))}
            </div>
          )}
          <footer className="mt-12 text-center text-xs text-gray-400">
            Powered by Gemini &middot; Built with rrrymz
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
